#!/bin/bash

if [ -z "$1" ]; then
  echo "Usage: $0 <file_or_directory>"
  exit 1
fi

if [[ "$(uname)" != "Darwin" ]]; then
  echo "Not on macOS, skipping leaks parse check."
  exit 0
fi

TARGET="$1"

if [ -d "$TARGET" ]; then
  while IFS= read -r -d '' file; do
    echo "Checking $file for leaks..."
    leaks --atExit -- ./herb parse "$file" --silent || exit 1
  done < <(find "$TARGET" -name "*.html.erb" -type f -print0)
else
  leaks --atExit -- ./herb parse "$TARGET" --silent
fi
