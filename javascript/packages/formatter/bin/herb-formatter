#!/usr/bin/env node

import fs from "fs/promises"
import { Formatter } from "@herb-tools/formatter"
import { Herb } from "@herb-tools/node-wasm"

async function readStdin() {
  const chunks = []

  for await (const chunk of process.stdin) {
    chunks.push(typeof chunk === "string" ? Buffer.from(chunk) : chunk)
  }

  return Buffer.concat(chunks).toString("utf8")
}

async function main() {
  const args = process.argv.slice(2)
  // Show help if no file argument is given and nothing is piped
  if (args.length === 0 && process.stdin.isTTY) {
    console.log(
`Usage: herb-formatter [FILE]
Formats FILE (or stdin if FILE is '-' or no FILE provided).

Examples:
  herb-formatter templates/index.html.erb
  cat template.html.erb | herb-formatter
`
    )
    process.exit(0)
  }
  let source

  if (args[0] && args[0] !== "-") {
    source = await fs.readFile(args[0], "utf8")
  } else {
    source = await readStdin()
  }

  await Herb.load()

  const formatter = new Formatter(Herb, {
    indentWidth: 2,
    maxLineLength: 80,
  })

  const result = formatter.format(source)

  process.stdout.write(result)
}

main().catch((err) => {
  console.error(err)
  process.exit(1)
})
