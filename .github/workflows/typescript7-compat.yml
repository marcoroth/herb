name: TypeScript 7 Compatibility Check

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  actions: read
  contents: read

jobs:
  tsgo-check:
    name: Check tsgo compatibility
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "yarn"

      - name: Add LLVM apt Repo
        run: |-
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/$(lsb_release -cs)/ llvm-toolchain-$(lsb_release -cs)-21 main"
          sudo apt update

      - name: Install APT dependencies
        run: xargs sudo apt-get install -y --no-install-recommends < Aptfile

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: bundle install
        run: bundle install

      - name: Render Templates
        run: bundle exec rake templates

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install TypeScript 7 native preview
        run: yarn add -D -W @typescript/native-preview

      - name: Check tsgo version
        run: npx tsgo --version

      - name: Type-check with tsgo
        run: |
          echo "Checking TypeScript 7 compatibility for all packages..."

          failed=0

          for dir in javascript/packages/*/; do
            pkg=$(basename "$dir")

            if [ -f "$dir/tsconfig.json" ]; then
              echo "::group::$pkg"

              if npx tsgo --noEmit --project "$dir/tsconfig.json" 2>&1; then
                echo "✅ $pkg passed"
              else
                echo "❌ $pkg failed"
                failed=1
              fi

              echo "::endgroup::"
            fi
          done

          if [ $failed -eq 1 ]; then
            echo ""
            echo "❌ Some packages have TypeScript 7 compatibility issues."
            exit 1
          else
            echo ""
            echo "✅ All packages are TypeScript 7 compatible!"
          fi
